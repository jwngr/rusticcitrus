!function(){"use strict";function e(){$("#deleteGamesAppBarButton").on("click",s),$("#confirmDeleteSelectedGamesButton").on("click",u),$("#cancelDeleteSelectedGamesButton").on("click",l),$("#forfeitGamesAppBarButton").on("click",m),$("#confirmForfeitSelectedGamesButton").on("click",d),$("#cancelForfeitSelectedGamesButton").on("click",c),$("#clearSelectionAppBarButton").on("click",g)}function t(){var e=$("#singlePlayerGamesListView")[0].winControl;e.removeEventListener("iteminvoked",RC.startSinglePlayerGame),e.removeEventListener("selectionchanging",RC.preventNewGameItemSelection),e.removeEventListener("selectionchanged",RC.toggleSinglePlayerGamesListAppBarVisibility),$("#deleteGamesAppBarButton").off("click"),$("#confirmDeleteSelectedGamesButton").off("click"),$("#cancelDeleteSelectedGamesButton").off("click"),$("#forfeitGamesAppBarButton").off("click"),$("#confirmForfeitSelectedGamesButton").off("click"),$("#cancelForfeitSelectedGamesButton").off("click"),$("#clearSelectionAppBarButton").off("click")}function n(e){var t=e.detail.queryText;console.log(t)}function a(e){RC.firebaseRoot.child("users/"+e.detail.tag+"/").once("value",function(e){var t=e.val(),n={roundwords:["BREAD","INDIGO","DYNAMIC"],creator:{id:RC.loggedInUser.id,facebookId:RC.loggedInUser.facebookId,firstName:RC.loggedInUser.firstName,lastName:RC.loggedInUser.lastName,username:RC.loggedInUser.username,gender:RC.loggedInUser.gender,imageUrl:RC.loggedInUser.imageUrl,timezone:RC.loggedInUser.timezone},opponent:{id:t.id,facebookId:t.facebookId,firstName:t.firstName,lastName:t.lastName,username:t.username,gender:t.gender,imageUrl:t.imageUrl,timezone:t.timezone}},a=RC.firebaseRoot.child("users/"+RC.loggedInUser.id+"/games/multiplayer/active/").push(n);RC.MultiplayerGames.yourTurnDataSource.insertAtEnd(a.name(),{isPlaceholder:!1,opponentName:n.opponent.firstName+" "+n.opponent.lastName,opponentImageUrl:n.opponent.imageUrl,scoreText:C(n.creator,n.opponent,!0),isLoggedInUsersTurn:!0,game:n})})}function i(e){var t=e.detail.queryText.toLowerCase(),n=e.detail.searchSuggestionCollection;n.appendQuerySuggestion("Random Opponent"),e.detail.setPromise(WinJS.Promise.join([r(t,5).then(function(e){e.length>0&&(n.appendSearchSeparator("Recent Opponents"),e.forEach(function(e){n.appendResultSuggestion(e.name,e.detailText,e.tag,e.image,e.imageAlternateText)}))}),o(t,5).then(function(e){e.length>0&&(n.appendSearchSeparator("Facebook Friends"),e.forEach(function(e){n.appendResultSuggestion(e.name,e.detailText,e.tag,e.image,e.imageAlternateText)}))})]))}function r(e,t){return new WinJS.Promise(function(n){RC.firebaseRoot.child("users/"+RC.loggedInUser.id+"/games/multiplayer/active/").once("value",function(a){var i=[],r=[];return a.forEach(function(n){var a=n.val();if(i.length<t){if(a.creator.id===RC.loggedInUser.id)var o=a.opponent;else var o=a.creator;if(-1===$.inArray(o.id,r)&&(0===e.length||o.firstName.substr(0,e.length).toLowerCase()===e||o.lastName.substr(0,e.length).toLowerCase()===e)){r.push(o.id);var s=new Windows.Foundation.Uri(o.imageUrl),l=Windows.Storage.Streams.RandomAccessStreamReference.createFromUri(s),u=o.firstName+" "+o.lastName;i.push({name:u,detailText:"Start a new game now!",tag:o.id,image:l,imageAlternateText:u})}}}),n(i)})})}function o(e,t){return new WinJS.Promise(function(n){var a=[];e.length>0?$.ajax({type:"get",url:"https://graph.facebook.com/me/friends",data:{access_token:"CAAHlqJGYzxEBACTZCRk3TG6WWIlrYhOFCrQXOyNB4gAqd20QLNCNJFVl47CxDu1YPMIR17D9dg5ikN0ZAZBkvFjpq1MUZCTAfNwyctBHNwX7vdTlZBIDHCBOa9B6GpBR9HSzHh6H2a388ZC5QQNHgeP3CKrxZCsjYZAdqEu3pp3fqZB5dUWIiERqZBOEpgpnrneXMZD",fields:"id, installed, first_name, last_name, gender, picture, timezone"},dataType:"json"}).done(function(i){for(var r=i.data.length,o=0;r>o&&a.length!==t;++o){var s=i.data[o];if(s.first_name.substr(0,e.length).toLowerCase()===e||s.last_name.substr(0,e.length).toLowerCase()===e){var l=new Windows.Foundation.Uri(s.picture.data.url),u=Windows.Storage.Streams.RandomAccessStreamReference.createFromUri(l),m=s.first_name+" "+s.last_name,c="Start a new game now!";s.installed||(c="Invite to Rustic Citrus!"),a.push({name:m,detailText:c,tag:"tag",image:u,imageAlternateText:m})}}n(a)}):n(a)})}function s(){1==$("#singlePlayerGamesListView")[0].winControl.selection.count()?$("#confirmDeleteSelectedGamesFlyout .pluralizer").hide():$("#confirmDeleteSelectedGamesFlyout .pluralizer").show(),confirmDeleteSelectedGamesFlyout.winControl.show($("#deleteGamesAppBarButton")[0],"top","center")}function l(){confirmDeleteSelectedGamesFlyout.winControl.hide()}function u(){RC.assert("object"==typeof RC.SinglePlayerGames.dataSource,"Single player games data source should already be defined"),singlePlayerGamesListView.winControl.selection.getItems().done(function(e){e.forEach(function(e){var t={numLetters:e.data.numLetters};RC.SinglePlayerGames.dataSource.change(e.key,t,e.index),RC.SinglePlayerGames.list[e.index]=t,RC.SinglePlayerGames.updateFile(),RC.firebaseRoot.child("users/"+RC.loggedInUser.id+"/games/singlePlayer/active/"+e.index).set(t)})}),g()}function m(){1==yourTurnMultiplayerGamesListView.winControl.selection.count()+theirTurnMultiplayerGamesListView.winControl.selection.count()?$("#confirmForfeitSelectedGamesFlyout .pluralizer").hide():$("#confirmForfeitSelectedGamesFlyout .pluralizer").show(),confirmForfeitSelectedGamesFlyout.winControl.show($("#forfeitGamesAppBarButton")[0],"top","center")}function c(){confirmForfeitSelectedGamesFlyout.winControl.hide()}function d(){RC.assert("object"==typeof RC.MultiplayerGames.yourTurnDataSource,"Your turn multiplayer games data source should already be defined"),RC.assert("object"==typeof RC.MultiplayerGames.theirTurnDataSource,"Their turn multiplayer games data source should already be defined"),yourTurnMultiplayerGamesListView.winControl.selection.getItems().done(function(e){e.forEach(function(e){RC.MultiplayerGames.yourTurnDataSource.remove(e.key,e.index),RC.firebaseRoot.child("users/"+RC.loggedInUser.id+"/games/multiplayer/active/"+e.key+"/").remove()})}),theirTurnMultiplayerGamesListView.winControl.selection.getItems().done(function(e){e.forEach(function(e){RC.MultiplayerGames.theirTurnDataSource.remove(e.key,e.index),RC.firebaseRoot.child("users/"+RC.loggedInUser.id+"/games/multiplayer/active/"+e.key+"/").remove()})}),g()}function g(){singlePlayerGamesListView.winControl.selection.clear(),yourTurnMultiplayerGamesListView.winControl.selection.clear(),theirTurnMultiplayerGamesListView.winControl.selection.clear(),gamesHubAppBar.winControl.sticky=!1,gamesHubAppBar.winControl.hide()}function f(e){var t=e.querySelector(".hub").winControl;"complete"===t.loadingState?(p(),h()):t.onloadingstatechanged=function(e){e.srcElement===t.element&&"complete"===e.detail.loadingState&&(t.onloadingstatechanged=null,p(),h())}}function p(){if(void 0===RC.SinglePlayerGames.dataSource){var e=WinJS.Class.derive(WinJS.UI.VirtualizedDataSource,function(){this._baseDataSourceConstructor(new y)});WinJS.Namespace.defineWithParent(RC,"SinglePlayerGames",{dataSource:new e})}$("#singlePlayerGamesListView")[0].winControl.itemDataSource=RC.SinglePlayerGames.dataSource}function h(){if(void 0===RC.MultiplayerGames){var e=WinJS.Class.derive(WinJS.UI.VirtualizedDataSource,function(){this._baseDataSourceConstructor(new S)}),t=WinJS.Class.derive(WinJS.UI.VirtualizedDataSource,function(){this._baseDataSourceConstructor(new v)});WinJS.Namespace.defineWithParent(RC,"MultiplayerGames",{yourTurnDataSource:new e,theirTurnDataSource:new t})}$("#yourTurnMultiplayerGamesListView")[0].winControl.itemDataSource=RC.MultiplayerGames.yourTurnDataSource,$("#theirTurnMultiplayerGamesListView")[0].winControl.itemDataSource=RC.MultiplayerGames.theirTurnDataSource}function C(e,t,n){var a,i=e.scores,r=t.scores;if(void 0===i)a=n?t.firstName+" has invited you to play! Click here to get started.":t.firstName+" has started a game and is playing the first round. Wait for your turn!";else if(void 0===r)RC.debug&&console.assert(!n,"This should not be a valid state"),a="You scored "+i[0]+" points in the first round but "+t.firstName+" is yet to play.";else{for(var o=Math.min(i.length,r.length),s=0,l=0;o>l;++l)s+=i[l];for(var u=0,l=0;o>l;++l)u+=r[l];var m=["one","two","three"];a=s>u?"You are winning "+s+" to "+u+" after "+m[o-1]+" "+(1===o?"round":"rounds")+"!":"You are losing "+s+" to "+u+" after "+m[o-1]+" "+(1===o?"round":"rounds")+"."}return a}WinJS.UI.Pages.define("/pages/gamesHub/gamesHub.html",{ready:function(t){e(),$("#deleteGamesAppBarButton").hide(),$("#forfeitGamesAppBarButton").hide(),"undefined"==typeof RC.SinglePlayerGames.dataSource?(RC.assert("undefined"==typeof RC.MultiplayerGames,"MultiplayerGames namespace should be undefined if single player games data source is undefined"),RC.debug?RC.SinglePlayerGames.deleteFile_DEBUG(function(){RC.SinglePlayerGames.load(function(){f(t)})}):RC.SinglePlayerGames.load(function(){f(t)})):(RC.assert("object"==typeof RC.MultiplayerGames.yourTurnDataSource&&"object"==typeof RC.MultiplayerGames.theirTurnDataSource,"Multiplayer games data source should be defined if single player games data source is defined"),f(t));var r=document.getElementById("newGameSearchBox");r.addEventListener("querysubmitted",n),r.addEventListener("suggestionsrequested",i),r.addEventListener("resultsuggestionchosen",a)},unload:function(){t()},updateLayout:function(){}});var y=WinJS.Class.define(function(){this.items=null},{itemsFromIndex:function(e,t,n){RC.assert("object"==typeof RC.SinglePlayerGames.list,"Single player games list should already be defined");var a=this;null===this.items&&(a.items=[],RC.SinglePlayerGames.list.forEach(function(e,t){a.items.push({key:t.toString(),data:{isPlaceholder:void 0===e.currentRound,game:e}})}));var a=this;return new WinJS.Promise(function(i){var r=a.items.length,o=e-t,s=Math.min(e+n,r-1);return i({items:a.items.slice(o,s+1),offset:e-o,totalCount:r})})},getCount:function(){RC.assert("object"==typeof RC.SinglePlayerGames.list,"Single player games list should already be defined");var e=this;return new WinJS.Promise(function(t){e.items?t(e.items.length):t(RC.SinglePlayerGames.list.length)})},change:function(e,t,n){var a=this;return new WinJS.Promise(function(i){a.itemsFromIndex(n,0,0).done(function(n){RC.assert(n.items[0].key===e,"key and index do not correspond to the same item"),n.items[0]=t,i(null)})})}}),S=WinJS.Class.define(function(){},{itemsFromIndex:function(e,t,n){var a=this;return new WinJS.Promise(function(i){if(a.items){var r=a.items.length,o=e-t,s=Math.min(e+n,r-1);return i({items:a.items.slice(o,s+1),offset:e-o,totalCount:r})}RC.firebaseRoot.child("users/"+RC.loggedInUser.id+"/games/multiplayer/active/").once("value",function(r){a.items=[],a.items.push({key:"newGame",data:{isPlaceholder:!0}});var o=[];r.forEach(function(e){var t=e.val(),n=t.creator.id==RC.loggedInUser.id?t.creator:t.opponent;$.extend(n,{facebookId:RC.loggedInUser.facebookId,firstName:RC.loggedInUser.firstName,lastName:RC.loggedInUser.lastName,username:RC.loggedInUser.username,gender:RC.loggedInUser.gender,imageUrl:RC.loggedInUser.imageUrl,timezone:RC.loggedInUser.timezone});var i=t.creator.id==RC.loggedInUser.id?t.opponent:t.creator,r=new WinJS.Promise(function(r){RC.firebaseRoot.child("users/"+i.id+"/").once("value",function(o){var s=o.val();$.extend(i,{facebookId:s.facebookId,firstName:s.firstName,lastName:s.lastName,username:s.username,gender:s.gender,imageUrl:s.imageUrl,timezone:s.timezone});var l=void 0===n.scores?0:n.scores.length,u=void 0===i.scores?0:i.scores.length,m=u>=l;m&&a.items.push({key:e.name(),data:{isPlaceholder:!1,opponentName:i.firstName+" "+i.lastName,opponentImageUrl:i.imageUrl,scoreText:C(n,i,m),isLoggedInUsersTurn:m,game:t}}),r()})});o.push(r)}),WinJS.Promise.join(o).done(function(){var r=a.items.length,o=e-t,s=Math.min(e+n,r-1);return i({items:a.items.slice(o,s+1),offset:e-o,totalCount:r})})})})},getCount:function(){var e=this;return new WinJS.Promise(function(t){e.items?t(e.items.length):RC.firebaseRoot.child("users/"+RC.loggedInUser.id+"/games/multiplayer/active/").once("value",function(e){var n=0;e.forEach(function(e){var t=e.val(),a=t.creator.id==RC.loggedInUser.id?t.creator:t.opponent,i=t.creator.id==RC.loggedInUser.id?t.opponent:t.creator,r=void 0===a.scores?0:a.scores.length,o=void 0===i.scores?0:i.scores.length,s=o>=r;s&&(n+=1)}),t(n+1)})})},insertAtEnd:function(e,t){var n={key:e,data:t};return this.items.push(n),new WinJS.Promise.wrap(n)},change:function(e,t,n){var a=this;return new WinJS.Promise(function(i){a.itemsFromIndex(n,0,0).done(function(n){RC.assert(n.items[0].key===e,"key and index do not correspond to the same item"),n.items[0]=t,i(null)})})},remove:function(e,t){var n=this.items.splice(t,1);return RC.assert(n[0].key===e,"key and index do not correspond to the same item"),new WinJS.Promise.wrap(null)}}),v=WinJS.Class.define(function(){},{itemsFromIndex:function(e,t,n){var a=this;return new WinJS.Promise(function(i){if(a.items){var r=a.items.length,o=e-t,s=Math.min(e+n,r-1);return i({items:a.items.slice(o,s+1),offset:e-o,totalCount:r})}RC.firebaseRoot.child("users/"+RC.loggedInUser.id+"/games/multiplayer/active/").once("value",function(r){a.items=[];var o=[];r.forEach(function(e){var t=e.val(),n=t.creator.id==RC.loggedInUser.id?t.creator:t.opponent;$.extend(n,{facebookId:RC.loggedInUser.facebookId,firstName:RC.loggedInUser.firstName,lastName:RC.loggedInUser.lastName,username:RC.loggedInUser.username,gender:RC.loggedInUser.gender,imageUrl:RC.loggedInUser.imageUrl,timezone:RC.loggedInUser.timezone});var i=t.creator.id==RC.loggedInUser.id?t.opponent:t.creator,r=new WinJS.Promise(function(r){RC.firebaseRoot.child("users/"+i.id+"/").once("value",function(o){var s=o.val();$.extend(i,{facebookId:s.facebookId,firstName:s.firstName,lastName:s.lastName,username:s.username,gender:s.gender,imageUrl:s.imageUrl,timezone:s.timezone});var l=void 0===n.scores?0:n.scores.length,u=void 0===i.scores?0:i.scores.length,m=u>=l;m||a.items.push({key:e.name(),data:{isPlaceholder:!1,opponentName:i.firstName+" "+i.lastName,opponentImageUrl:i.imageUrl,scoreText:C(n,i,m),isLoggedInUsersTurn:m,game:t}}),r()})});o.push(r)}),WinJS.Promise.join(o).done(function(){var r=a.items.length,o=e-t,s=Math.min(e+n,r-1);return i({items:a.items.slice(o,s+1),offset:e-o,totalCount:r})})})})},getCount:function(){var e=this;return new WinJS.Promise(function(t){e.items?t(e.items.length):RC.firebaseRoot.child("users/"+RC.loggedInUser.id+"/games/multiplayer/active/").once("value",function(e){var n=0;e.forEach(function(e){var t=e.val(),a=t.creator.id==RC.loggedInUser.id?t.creator:t.opponent,i=t.creator.id==RC.loggedInUser.id?t.opponent:t.creator,r=void 0===a.scores?0:a.scores.length,o=void 0===i.scores?0:i.scores.length,s=o>=r;s||(n+=1)}),t(n)})})},insertAtEnd:function(e,t){var n={key:e,data:t};return this.items.push(n),new WinJS.Promise.wrap(n)},change:function(e,t,n){var a=this;return new WinJS.Promise(function(i){a.itemsFromIndex(n,0,0).done(function(n){RC.assert(n.items[0].key===e,"key and index do not correspond to the same item"),n.items[0]=t,i(null)})})},remove:function(e,t){var n=this.items.splice(t,1);return RC.assert(n[0].key===e,"key and index do not correspond to the same item"),new WinJS.Promise.wrap(null)}});RC.handleSinglePlayerGameListItemSelection=WinJS.Utilities.markSupportedForProcessing(function(e){e.detail.newSelection.getItems().done(function(t){for(var n=0;n<t.length;n++)t[n].data.isPlaceholder&&e.preventDefault()})}),RC.handleMultilayerGameListItemSelection=WinJS.Utilities.markSupportedForProcessing(function(e){e.detail.newSelection.getItems().done(function(t){for(var n=0;n<t.length;n++)t[n].data.isPlaceholder&&e.preventDefault()})}),RC.toggleGamesHubAppBarVisibility=WinJS.Utilities.markSupportedForProcessing(function(){var e=$("#gamesHubAppBar")[0].winControl,t=$("#singlePlayerGamesListView")[0].winControl.selection.count(),n=$("#yourTurnMultiplayerGamesListView")[0].winControl.selection.count()+$("#theirTurnMultiplayerGamesListView")[0].winControl.selection.count(),a=$("#deleteGamesAppBarButton"),i=$("#forfeitGamesAppBarButton");0==t+n?(e.sticky=!1,e.hide(),a.hide(),i.hide()):(e.sticky=!0,e.show(),0==t?(a.hide(),i.show()):0==n?(i.hide(),a.show()):(i.hide(),a.hide()))}),RC.startSinglePlayerGame=WinJS.Utilities.markSupportedForProcessing(function(e){e.detail.itemPromise.done(function(e){e.data.isPlaceholder?WinJS.Navigation.navigate("/pages/gameBoard/gameBoard.html",{gameType:"singlePlayer",resumeGame:!1,numLetters:e.data.game.numLetters}):WinJS.Navigation.navigate("/pages/gameBoard/gameBoard.html",{gameType:"singlePlayer",resumeGame:!0,game:e.data.game})})}),RC.loadMultiplayerGameSummary=WinJS.Utilities.markSupportedForProcessing(function(e){e.detail.itemPromise.done(function(e){e.data.isPlaceholder?setTimeout(function(){$("#newGameSearchBox > .win-searchbox-input").focus()},10):(e.data.game.gameId=e.key,WinJS.Navigation.navigate("/pages/multiplayerGameSummary/multiplayerGameSummary.html",{gameType:"multiplayer",game:e.data.game,isLoggedInUsersTurn:e.data.isLoggedInUsersTurn}))})})}();